<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>txt书籍设置</title>
</head>
<link rel="icon" href="/favicon.ico" type="image/x-icon">
<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
<link rel="stylesheet" type="text/css" charset="utf-8" href="css/font.css">
<style>
body {
	background-color: #FFF;
	color: #000
}
a {
	text-decoration: none;
	color: rgb(0, 0,0);
}
div, textarea {
	font-family: "微软雅黑", Tahoma, Arial, Helvetica, sans-serif, TH-Tshyn-P0, TH-Tshyn-P1, TH-Tshyn-P2;
}
#bkdiv span {
	color: red;
}
input[id^='bk'] {
	width: 210px;
}
input[type='button'] {
	margin-top: 4px;
	padding: 1px 2px;
	;
}
.btn {
	display: inline;
	padding: 1px;
	margin-bottom: 0;
	font-size: 0.8rem;
	font-weight: 300;
	line-height: 20px;
	color: #FFF;
	text-align: center;
	white-space: nowrap;
	box-shadow: 0 0 #74a3b0;
	background-color: #669;
	border: 1px solid transparent;
	border-radius: 4px;
}
.btn:hover {
	background-color: #699DD1;
	border-color: #e74c3c
}
.eye{
	background-color:rgb(250,249,222);
	color:rgb(110,122,108);
}
.def{
	background-color:#9F6;
	color:#00F;
}
</style>
<link rel="stylesheet" type="text/css" href="css/Aimara.css">
<body>
<div style="position:fixed;width:100%;height:100%;">
  <div id="stdiv" style="word-break:break-all;padding: 12px 4px;z-index:1;border: 2px solid blue;position:fixed;overflow-x: hidden;float:left;width:300px;height: calc(98% - 24px);">
    <div id="stck0" style="display:block;user-select:none">
      <button onClick="expand_all()">展开</button>
      <button onClick="collapse_all()">收缩</button>
      <input type="checkbox" id="gbgs" checked="checked">
      光标跟随 <span class="btn icon-home3"></span> <span class="btn icon-question"></span> <span class="btn icon-eye"></span> <span class="btn icon-pencil"></span> <span class="btn icon-floppy-disk"></span> <span id="mcos" class="btn icon-shrink"></span>
      <hr/>
    </div>
    <div id="stck1" style="display:block"> 书名：
      <input id="bkname" type="text" />
      <br/>
      作者：
      <input id="bkauthor" type="text" />
      <br/>
      朝代：
      <input id="bkdate" type="text" />
      <br/>
      版权：
      <input type="text" id="bkcopyright"/>
      <br/>
      分类：
      <input type="text" id="bktype"/>
      <br/>
      字数：
      <input id="bknum" type="text" />
      <br/>
      说明：
      <input id="bkdec" type="text" />
      <br/>
      封面：
      <input id="bkimg" type="text" />
      <img id="bkimgdv" style="margin-left:50px;width:200px;"/> <br/>
    </div>
    <div id="div_tree"></div>
    <span class="btn icon-point-up" style="position:fixed;bottom:20px;left:270px;cursor:default;float:right;">上置</span> </div>
  <div id="bkhet"style="position:fixed;border: 2px solid red;left:326px;width: calc(100% - 336px);height: 98%;">
    <div id="bkdiv" contenteditable="true" class="def" style="word-break:break-all;overflow-x: hidden;width:100%;height:100%;font-size: 18px;font-weight: bold;"></div>
  </div>
</div>
<script type="text/javascript" src="js/global.js"></script> 
<script src="js/Aimara.js" type="text/javascript"></script> 
<script type="text/javascript">
var scrtime=null;
window.onload = function() {
	
	document.querySelector(".icon-point-up").onmousedown = function (e) {
		if(this.innerHTML=="向下滚动"){
			if(scrtime)clearInterval(scrtime);
			scrtime=self.setInterval(function clock(){
				bkdiv.scrollTop+=5;	
			},50)
		}		
		else
		stdiv.scrollTop=0;
	}
	document.querySelector(".icon-point-up").onmouseup = function (e) {
		if(scrtime)scrtime=clearInterval(scrtime);
	}
	document.querySelector(".icon-question").onclick = function (e) {
		stck1.style.display=stck1.style.display=="none"?"block":"none";
	}
	document.querySelector(".icon-eye").onclick = function (e) {
		if(bkdiv.className=="eye")
		bkdiv.className="def";
		else
		bkdiv.className="eye";
	}
	document.querySelector(".icon-pencil").onclick = function (e) {
		window.win = window.open("book/book.html", "_blank");
	}
	document.querySelector(".icon-floppy-disk").onclick = function (e) {
		down(bkname.value+".txt", localStorage.cxval)
	}
	document.querySelector(".icon-home3").onclick = function (e) {
		location.href="https://daxuanguji.github.io/";
	}
	mcos.onclick = function (e) {
		if(this.className=="btn icon-shrink"){
		stdiv.style.marginLeft="-315px";
		this.style.position="fixed";
		this.className="btn icon-enlarge";
		this.style.left="2px";
		this.style.top="2px";
		bkhet.style.left="0";
		bkhet.style.width="calc(100% - 6px)";
		document.querySelector(".icon-point-up").style.marginLeft="calc(100% - 356px)";
		document.querySelector(".icon-point-up").innerHTML="向下滚动";
		}
		else{
		document.querySelector(".icon-point-up").style.marginLeft=stdiv.style.marginLeft="auto";
		document.querySelector(".icon-point-up").innerHTML="上置";
		this.style.position="";
		this.className="btn icon-shrink";
		bkhet.style.left="326px";
		bkhet.style.width="calc(100% - 336px)";	
		}
	}
	
	var lock=0;	
	
	var book_name=getUVAL("name")?getUVAL("name")[1]:"三国演义";
	var book_type=getUVAL("type")?getUVAL("type")[1]:"文学艺术";
	var turl=_host.txt+"0&b=0&e=0&t=" +book_name+ "&p=" +book_type;
	var txtcon=function (txt) {	
		txt=txt.replace(/\[book_dec\][^\n]*\n/,"");
		txt=txt.replace(/\[book_img\][^\n]*\n/,"");
		txt=txt.replace(/\[book_name\][^\n]*\n/,"");
		txt=txt.replace(/\[book_author\][^\n]*\n/,"");
		txt=txt.replace(/\[book_date\][^\n]*\n/,"");
		txt=txt.replace(/\[book_copyright\][^\n]*\n/,"");
		txt=txt.replace(/\[book_type\][^\n]*\n/,"");
		txt=txt.replace(/\[book_length\][^\n]*\n/,"");
		txt=txt.replace(/\[config\]([\W\w]+)\[config\]\n*/,"\n");
		return txt;
	}
	var sxtcon=function (txt) {	
		var mat=txt.match(/\[book_name\]([^\n]+)/);
		bkname.value=mat?mat[1]:"";
		if(!bkname.value){
			mat=txt.match(/ptname@([^\n\/]+)/);
			bkname.value=mat?mat[1]:"无书名";
		}
		mat=txt.match(/\[book_author\]([^\n]+)/);
		bkauthor.value=mat?mat[1]:"";
		if(!bkauthor.value){
			mat=txt.match(/ptauthor@([^\n\/]+)/);
			bkauthor.value=mat?mat[1].split("=").length>1?mat[1].split("=")[1]:"佚名":"佚名";
		}
		if(/\d/.test(bkauthor.value))bkauthor.value="佚名";
		if(bkauthor.value[bkauthor.value.length-1]!=="㊣")bkauthor.value+="㊣";
		mat=txt.match(/\[book_date\]([^\n]+)/);		
		bkdate.value=mat?mat[1]:"";
		if(!bkdate.value){
			mat=txt.match(/ptauthor@([^\n\/]+)/);
			bkdate.value=mat?mat[1].split("=")[0]:"未知";		
		}
		mat=txt.match(/\[book_copyright\]([^\n]+)/);
		bkcopyright.value=mat?mat[1]:"";
		if(!bkcopyright.value){
			mat=txt.match(/ptcopyright@([^\n\/]+)/);
			bkcopyright.value=mat?mat[1]:"玄之又玄 謂之大玄=學海無涯君是岸=書山絕頂吾为峰=大玄古籍書店獨家出版";
		}
		mat=txt.match(/\[book_type\]([^\n]+)/);
		bktype.value=mat?mat[1]:"未分类";
		mat=txt.match(/\[book_img\]([^\n]+)/);
		bkimg.value=mat?mat[1]:"null";
		mat=txt.match(/\[book_dec\]([^\n]+)/);
		bkdec.value=mat?mat[1]:"null";
		mat=txt.match(/\[book_length\]([^\n]+)/);
		bknum.value=mat?mat[1]:"";
		if(bkimg.value.indexOf('.')>0){			
			//var ty=_Tconst.getBookType(book_type);
			//bkimgdv.src=_host.txt+"0&b=0&e=0&t=" +bkimg.value+ "&p="+ty;
		}
		
	}
	var txtrep=function (txt) {	
		if(lock==1)return;
		lock=1;
		txt=txt.replace(/\r/g,"");
		sxtcon(txt.slice(0,1500));
		txt=txtcon(txt);			
		var bk_i=[0,0,0,0];
		var bk_node=[null,null,null,null];			
		bk_node[0] = tree.createNode(bkname.value,false,'images/star.png',null,null,'context1');
		txt=txt.replace(/\[book_(chapter|title|node|point)\]([^\r\n]+)/g,
		function (a,b,c){
			switch (b) {
			case "chapter":
				bk_i[0]++;
				bk_node[1]=bk_node[0].createChildNode(a.replace("[book_chapter]",""),false,'images/magic_ball.png',"setidx('cbk"+bk_i[0]+"',e)",'context1');	
				return '<span id="cbk'+bk_i[0]+'">✪</span>'+c;
				break;
			case "title":
				bk_i[1]++;
				bk_node[2]=bk_node[0].createChildNode(a.replace("[book_title]",""), false, 'images/blue_key.png',"setidx('tbk"+bk_i[1]+"',e)",'context1');	
				return '<span id="tbk'+bk_i[1]+'">■</span>'+c;
				break;
			case "node":
				bk_i[2]++;
				bk_node[3]=bk_node[2].createChildNode(a.replace("[book_node]",""), false, 'images/tree.png',"setidx('nbk"+bk_i[2]+"',e)",'context1');	
				return '<span id="nbk'+bk_i[2]+'">❖</span>'+c;
				break;
			case "point":
				bk_i[3]++;
				bk_node[4]=bk_node[3].createChildNode(a.replace("[book_point]",""), false, 'images/leaf.png',"setidx('pbk"+bk_i[3]+"',e)",'context1');
				return '<span id="pbk'+bk_i[3]+'">▲</span>'+c;
				break;
			default:
				return a;
				break;
			}
		})
										
		bkdiv.innerHTML=txt.replace(/\n/g,'<br/>');	
		tree.drawTree();
		lock=0;
				
	}
	var contex_menu = {};
	tree = createTree('div_tree','white',contex_menu);
	tree.nodeBeforeOpenEvent = function(node) {stck1.style.display="none";}
	tree.nodeAfterOpenEvent = function(node) {}
	tree.nodeBeforeCloseEvent = function(node) {}	
	var geturl=function(url,fun,type,prog) {
		fun(localStorage.cxval)
	}
geturl(turl,function (txt) {
	if("undefined"!==typeof node1 )node1.removeNode();
	txtrep(txt.replace(/<\s*([\d+a-zA-Z]+)[^>]+>/g,function (a,b){
		a=a.replace(/\s[a-zA-Z\d+-_]+\s*=\s*(['"][\u3400-\uFAD9])/g,'title=$1')
		return a+"⚠</"+b+">";
	}));
	setTimeout(function () {stck1.style.display="none";expand_all();},3000);
	try{localStorage.cxval =txt;}catch(e){}
	
})
window.onmessage=function (e) {	
	if(e.data[0]=="$"){
			txtrep(localStorage.cxval);
			setTimeout(function () {stck1.style.display="none";expand_all();},3000);;
		}
}
};
function expand_all() {tree.expandTree();}
function collapse_all() {tree.collapseTree();}
function setidx(id,e) {
	if(!e)return;
	var obj=document.getElementById(id);
	console.log([bkdiv.offsetHeight,bkdiv.clientHeight,bkdiv.scrollHeight,e.clientY ,e.offsetY]);	
	var rtop =obj.offsetTop;
	var rleft =obj.offsetLeft;
	if(bkdiv.offsetHeight-e.clientY<15)gbgs.checked=false;									
	bkdiv.scrollTop =gbgs.checked?rtop-(e.clientY):rtop;
	if(document.getElementById("ndiv"))document.body.removeChild(document.getElementById("ndiv"));
		var tg = document.createElement('div');
		tg.style.position = "absolute";
		tg.style.backgroundColor = "rgba(255,0,0,0.3)";
		tg.style.left = bkhet.style.left;
		tg.style.width = bkhet.style.width;
		tg.style.transition = "all 0.2s";
		tg.style.pointerEvents = 'none';
		tg.style.top = !gbgs.checked?2+"px":bkdiv.scrollTop?(e.clientY+2)+"px":(rtop+2)+"px";
		if(bkdiv.scrollTop==bkdiv.scrollHeight-bkdiv.offsetHeight){
			tg.style.top =(rtop-bkdiv.scrollTop+2)+"px";
		}
		tg.style.height = obj.offsetHeight+"px";
		tg.style.zIndex = 112;								
		tg.id="ndiv";			
		document.body.appendChild(tg);

	
	//alert(idx);
	
	//var range = document.selection.createRange();
	
}
bkdiv.onscroll=bkdiv.onwheel=function (e) {
	//alert(bkdiv.scrollTop)
	console.log(e );if(document.getElementById("ndiv")){
			setTimeout(function () {
				if(document.getElementById("ndiv"))document.body.removeChild(document.getElementById("ndiv"));
			},2000)
		}
}
</script>
<script type="text/javascript" src="js/use_settings.js" charset="UTF-8"></script>
</body>
</html>
